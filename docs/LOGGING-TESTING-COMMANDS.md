# üß™ Logging Testing Commands

Quick reference for testing the logging implementation.

---

## üöÄ Build & Run

### Development Mode

```bash
# Clean build
./mvnw clean package -DskipTests

# Run with dev profile (human-readable logs)
SPRING_PROFILES_ACTIVE=dev ./mvnw spring-boot:run

# Or run the JAR
SPRING_PROFILES_ACTIVE=dev java -jar target/auth-service-0.0.1-SNAPSHOT.jar
```

### Production Mode

```bash
# Build
./mvnw clean package -DskipTests

# Run with prod profile (JSON logs)
SPRING_PROFILES_ACTIVE=prod java -jar target/auth-service-0.0.1-SNAPSHOT.jar
```

### Docker

```bash
# Build image
docker build -t exploresg-auth-service:latest .

# Run container
docker run -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -e SPRING_DATASOURCE_URL=jdbc:postgresql://host.docker.internal:5432/exploresg-auth-service-db \
  -e SPRING_DATASOURCE_USERNAME=exploresguser \
  -e SPRING_DATASOURCE_PASSWORD=exploresgpass \
  -e JWT_SECRET_KEY=your-secret-key \
  -e OAUTH2_JWT_AUDIENCES=your-google-client-id \
  exploresg-auth-service:latest

# View logs
docker logs -f <container-id>
```

---

## üß™ Test Commands

### 1. Test Basic Health Check

```bash
# Simple request (no auth needed)
curl http://localhost:8080/api/v1/check?email=test@example.com

# Expected logs:
# [INFO] Incoming request: GET /api/v1/check from IP: 127.0.0.1
# [INFO] Completed request: GET /api/v1/check - Status: 200 - Duration: 23ms
```

### 2. Test Correlation ID Generation

```bash
# Request without correlation ID (auto-generated)
curl -v http://localhost:8080/api/v1/check?email=test@example.com

# Check response headers for:
# < X-Correlation-ID: <auto-generated-uuid>

# Logs should include the same correlation ID
```

### 3. Test Custom Correlation ID

```bash
# Provide custom correlation ID
curl -v http://localhost:8080/api/v1/check?email=test@example.com \
  -H "X-Correlation-ID: my-custom-trace-id-12345"

# Verify in response:
# < X-Correlation-ID: my-custom-trace-id-12345

# Search logs for your ID:
grep "my-custom-trace-id-12345" logs/exploresg-auth-service.log
```

### 4. Test Authenticated Request (User Context)

```bash
# First, get a JWT token (replace with your actual token)
export JWT_TOKEN="eyJhbGciOiJIUzI1..."

# Make authenticated request
curl http://localhost:8080/api/v1/me \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "X-Correlation-ID: auth-test-123"

# Expected logs should include:
# - correlationId: auth-test-123
# - userId: (your user ID)
# - userEmail: (your email)
```

### 5. Test Signup (Security Audit Log)

```bash
# Make signup request (requires JWT)
curl -X POST http://localhost:8080/api/v1/signup \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -H "X-Correlation-ID: signup-test-456" \
  -d '{
    "givenName": "John",
    "familyName": "Doe",
    "phone": "+65-9123-4567",
    "dateOfBirth": "1990-01-15",
    "drivingLicenseNumber": "S1234567A",
    "passportNumber": "E1234567",
    "preferredLanguage": "en",
    "countryOfResidence": "Singapore"
  }'

# Expected logs:
# [INFO] User signup/profile update initiated for userId: X, email: user@example.com
# [INFO] User profile successfully created/updated for userId: X
```

### 6. Test Admin Access (Role-Based)

```bash
# Access admin endpoint (requires ADMIN role)
curl http://localhost:8080/api/v1/admin/dashboard \
  -H "Authorization: Bearer $ADMIN_JWT_TOKEN" \
  -H "X-Correlation-ID: admin-test-789"

# Expected log:
# [INFO] Admin dashboard accessed by userId: X, email: admin@example.com
```

### 7. Test Error Logging

```bash
# Trigger an error (invalid email format)
curl http://localhost:8080/api/v1/check

# Or access protected endpoint without auth
curl http://localhost:8080/api/v1/me

# Check error logs:
tail -f logs/exploresg-auth-service-error.log
```

### 8. Test Slow Request Warning

```bash
# If you have an endpoint that takes >2 seconds,
# you'll see a WARN log:
# [WARN] Slow request detected: GET /api/v1/some-slow-endpoint took 3245ms
```

---

## üìä Log Verification

### Check Log Files

```bash
# View main log file
tail -f logs/exploresg-auth-service.log

# View error log only
tail -f logs/exploresg-auth-service-error.log

# View last 100 lines
tail -n 100 logs/exploresg-auth-service.log

# Search for specific user
grep "userId\":\"42\"" logs/exploresg-auth-service.log

# Search for errors
grep "ERROR" logs/exploresg-auth-service.log

# Search by correlation ID
grep "abc-123-def" logs/exploresg-auth-service.log
```

### Verify JSON Format (Production)

```bash
# Start in prod mode
SPRING_PROFILES_ACTIVE=prod java -jar target/auth-service-0.0.1-SNAPSHOT.jar

# Make a request
curl http://localhost:8080/api/v1/check?email=test@example.com

# Logs should be valid JSON - test with jq:
tail -n 1 logs/exploresg-auth-service.log | jq .

# Expected output (pretty-printed JSON):
{
  "timestamp": "2025-10-11T14:23:45.123Z",
  "level": "INFO",
  "thread": "http-nio-8080-exec-1",
  "logger": "com.exploresg.authservice.config.RequestLoggingInterceptor",
  "message": "Incoming request: GET /api/v1/check from IP: 127.0.0.1",
  "correlationId": "abc-123-def",
  "requestMethod": "GET",
  "requestPath": "/api/v1/check",
  "clientIp": "127.0.0.1",
  "application": "exploresg-auth-service",
  "environment": "prod"
}
```

### Extract Specific Fields from JSON Logs

```bash
# Get all correlation IDs
grep "correlationId" logs/exploresg-auth-service.log | jq -r .correlationId

# Get all user IDs
grep "userId" logs/exploresg-auth-service.log | jq -r .userId

# Get all request paths
grep "requestPath" logs/exploresg-auth-service.log | jq -r .requestPath

# Get all errors
grep "ERROR" logs/exploresg-auth-service.log | jq '{timestamp, message, correlationId}'
```

---

## üê≥ Docker Testing

### View Container Logs

```bash
# Get container ID
docker ps

# Follow logs
docker logs -f <container-id>

# Last 100 lines
docker logs --tail 100 <container-id>

# Since specific time
docker logs --since 2025-10-11T14:00:00 <container-id>

# With timestamps
docker logs -t <container-id>
```

### Test in Docker Compose

```bash
# Start services
docker-compose up -d

# View logs
docker-compose logs -f backend-auth-dev

# View logs from all services
docker-compose logs -f

# Stop services
docker-compose down
```

---

## ‚ò∏Ô∏è Kubernetes Testing

### View Pod Logs

```bash
# Get pod name
kubectl get pods -n exploresg

# View logs
kubectl logs -f <pod-name> -n exploresg

# View logs from specific container
kubectl logs -f <pod-name> -c auth-service -n exploresg

# Previous container logs (after crash)
kubectl logs <pod-name> -n exploresg --previous

# Last 100 lines
kubectl logs --tail=100 <pod-name> -n exploresg

# Since specific time
kubectl logs --since=1h <pod-name> -n exploresg
```

### Search Logs in Kubernetes

```bash
# Search for correlation ID
kubectl logs <pod-name> -n exploresg | grep "abc-123-def"

# Search for errors
kubectl logs <pod-name> -n exploresg | grep "ERROR"

# Search for specific user
kubectl logs <pod-name> -n exploresg | grep "userId\":\"42\""

# Parse JSON logs
kubectl logs <pod-name> -n exploresg | jq 'select(.level == "ERROR")'
```

---

## üìà Performance Testing

### Load Test with Correlation IDs

```bash
# Using Apache Bench
for i in {1..100}; do
  ab -n 1000 -c 10 \
    -H "X-Correlation-ID: load-test-$i" \
    http://localhost:8080/api/v1/check?email=test@example.com
done

# Check for slow request warnings
grep "Slow request detected" logs/exploresg-auth-service.log
```

### Monitor Log File Size

```bash
# Watch log file grow
watch -n 1 'ls -lh logs/exploresg-auth-service*.log'

# Check disk usage
du -sh logs/

# Verify log rotation is working
ls -lh logs/exploresg-auth-service.*.log
```

---

## üîç Debugging

### Enable Debug Logging Temporarily

```bash
# Set environment variable
export LOGGING_LEVEL_COM_EXPLORESG=DEBUG

# Or via application properties
echo "logging.level.com.exploresg=DEBUG" >> application-prod.properties

# Restart application
```

### Test MDC Context

```bash
# Make authenticated request
curl http://localhost:8080/api/v1/me \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "X-Correlation-ID: mdc-test-999"

# Check that all logs include MDC fields:
grep "mdc-test-999" logs/exploresg-auth-service.log | jq '{correlationId, userId, userEmail}'
```

### Verify Filter Order

```bash
# Check startup logs for filter registration
grep "Filter" logs/exploresg-auth-service.log | head -20

# Should see:
# - RequestCorrelationFilter (order: -2147483648)
# - UserContextLoggingFilter (order: -2147483638)
```

---

## ‚úÖ Validation Checklist

Run these commands to validate logging is working correctly:

```bash
# 1. Build succeeds
./mvnw clean package -DskipTests
# ‚úÖ Expected: BUILD SUCCESS

# 2. Application starts
SPRING_PROFILES_ACTIVE=dev ./mvnw spring-boot:run &
sleep 10
# ‚úÖ Expected: Application runs on port 8080

# 3. Correlation ID works
RESPONSE=$(curl -v http://localhost:8080/api/v1/check?email=test@example.com 2>&1)
echo "$RESPONSE" | grep "X-Correlation-ID"
# ‚úÖ Expected: X-Correlation-ID header in response

# 4. Logs are generated
ls -lh logs/exploresg-auth-service.log
# ‚úÖ Expected: Log file exists and has content

# 5. JSON format works (prod)
SPRING_PROFILES_ACTIVE=prod java -jar target/auth-service-0.0.1-SNAPSHOT.jar &
sleep 10
curl http://localhost:8080/api/v1/check?email=test@example.com
tail -n 1 logs/exploresg-auth-service.log | jq .
# ‚úÖ Expected: Valid JSON output

# 6. Clean up
pkill -f auth-service
```

---

## üÜò Troubleshooting

### Logs Not Appearing

```bash
# Check if logback-spring.xml exists
ls -l src/main/resources/logback-spring.xml

# Check log directory permissions
mkdir -p logs
chmod 755 logs

# Check profile is active
echo $SPRING_PROFILES_ACTIVE
```

### JSON Logs Not Working

```bash
# Verify dependency
./mvnw dependency:tree | grep logstash

# Check profile
# Should be 'staging' or 'prod'
echo $SPRING_PROFILES_ACTIVE
```

### Correlation ID Missing

```bash
# Check filter is loaded
curl -v http://localhost:8080/api/v1/check?email=test@example.com 2>&1 | grep "X-Correlation-ID"

# If missing, check startup logs
grep "RequestCorrelationFilter" logs/exploresg-auth-service.log
```

---

**For complete documentation, see:**

- [LOGGING-GUIDE.md](LOGGING-GUIDE.md) - Comprehensive guide
- [LOGGING-ARCHITECTURE.md](LOGGING-ARCHITECTURE.md) - Architecture diagrams
- [LOGGING-IMPLEMENTATION-SUMMARY.md](LOGGING-IMPLEMENTATION-SUMMARY.md) - Implementation summary
